# Оптимизация кэширования изображений

## Что было сделано:

### 1. Service Worker для кэширования (public/sw.js)
- Создан Service Worker, который кэширует все изображения на 30 дней
- Используется стратегия Cache First для изображений
- Автоматическая проверка времени жизни кэша
- Возврат устаревшего кэша при отсутствии сети

### 2. HTTP заголовки для кэширования (vercel.json)
- Настроены Cache-Control заголовки для всех изображений
- /photo/* - кэш на 30 дней (2592000 секунд)
- /assets/* - кэш на 1 год (31536000 секунд)
- Все изображения помечены как immutable для лучшей производительности

### 3. Оптимизация компонента ImageWithFallback
- Добавлена предзагрузка изображений
- Ленивая загрузка (loading="lazy")
- Асинхронное декодирование (decoding="async")
- Отслеживание загруженных изображений в localStorage
- Индикатор загрузки

### 4. Управление кэшем (lib/imageCache.ts)
- Функция автоматической очистки старого кэша (>30 дней)
- Проверка наличия изображения в кэше
- Статистика использования кэша

### 5. Оптимизация Vite (vite.config.ts)
- Отключен инлайн для изображений (для раздельного кэширования)
- Стабильные имена файлов с хэшем
- Организация ассетов по типам
- Оптимизированная обработка статических ресурсов

### 6. Замена изображений в магазине
- Все внешние URL заменены на локальные файлы из папки /photo
- Матрешка заменена на Магнитик2.png
- Используются реальные фотографии товаров

## Как это работает:

### При первом посещении:
1. Service Worker регистрируется
2. Изображения загружаются с сервера
3. Service Worker сохраняет их в кэш с меткой времени
4. URL сохраняется в localStorage

### При повторном посещении (в течение 30 дней):
1. Service Worker проверяет наличие изображения в кэше
2. Если кэш валиден (< 30 дней) - возвращает из кэша (304 Not Modified)
3. Если кэша нет - загружает с сервера и кэширует

### При переключении между вкладками:
- Все статические ресурсы берутся из кэша браузера
- Нет повторных запросов к серверу
- Ответ 304 Not Modified для неизмененных ресурсов

## HTTP заголовки:

```
Cache-Control: public, max-age=2592000, immutable
```

- `public` - ресурс может кэшироваться всеми (браузеры, CDN)
- `max-age=2592000` - кэш на 30 дней
- `immutable` - ресурс не изменится, браузер не будет делать условные запросы

## Проверка работы:

1. Откройте DevTools -> Network
2. Первая загрузка - статус 200 (загрузка с сервера)
3. Обновите страницу - статус 304 (из кэша)
4. Откройте новую вкладку - статус 304 (из кэша)

## Преимущества:

✅ Быстрая загрузка при повторном посещении
✅ Работа офлайн для закэшированных ресурсов
✅ Экономия трафика
✅ Ответ 304 Not Modified между вкладками
✅ Автоматическая очистка старого кэша
✅ Индикаторы загрузки для лучшего UX

## Статистика:

Проверить статистику кэша можно в консоли браузера:
```javascript
// Статистика выводится при загрузке приложения
// Показывает: total (всего), valid (валидных), expired (устаревших)
```

## Примечания:

- Кэш очищается автоматически через 30 дней
- Service Worker обновляется при изменении файла sw.js
- При обновлении приложения старый кэш удаляется
- localStorage используется только для отслеживания, основной кэш в Service Worker
